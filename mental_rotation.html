<!doctype html>
<html>

    <head>
        <title>mental rotation task</title>
        <!-- jQuery -->
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- Load the jspsych library and plugins -->
        <script src="scripts/jspsych.js"></script>
        <script src="scripts/plugins/jspsych-two-stim.js"></script>
        <script src="scripts/plugins/jspsych-xab.js"></script>
        <!-- style -->
        <link href="css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>

    <body>
        <div id="jspsych_target"></div>
    </body>
    <script type="text/javascript">

        var images = [
            {stimulus:"img/mental_rotation/RotacijaA/A-0.gif", data: {item: "A", type: "identical", correct_key: "81", rotation: "0"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-0m.gif", data: {item: "A", type: "mirrored", correct_key: "80", rotation: "0"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-120.gif", data: {item: "A", type: "identical", correct_key: "81", rotation: "120"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-120m.gif", data: {item: "A", type: "mirrored", correct_key: "80", rotation: "120"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-180.gif", data: {item: "A", type: "identical", correct_key: "81", rotation: "180"}}/*,
            {stimulus:"img/mental_rotation/RotacijaA/A-180m.gif", data: {item: "A", type: "mirrored", correct_key: "80", rotation: "180"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-240.gif", data: {item: "A", type: "identical", correct_key: "81", rotation: "240"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-240m.gif", data: {item: "A", type: "mirrored", correct_key: "80", rotation: "240"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-300.gif", data: {item: "A", type: "identical", correct_key: "81", rotation: "300"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-300m.gif", data: {item: "A", type: "mirrored", correct_key: "80", rotation: "300"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-60.gif", data: {item: "A", type: "identical", correct_key: "81", rotation: "60"}},
            {stimulus:"img/mental_rotation/RotacijaA/A-60m.gif", data: {item: "A", type: "mirrored", correct_key: "80", rotation: "60"}},
            {stimulus:"img/mental_rotation/RotacijaA/B-0.gif", data: {item: "B", type: "identical", correct_key: "81", rotation: "0"}},
            {stimulus:"img/mental_rotation/RotacijaA/B-0m.gif", data: {item: "B", type: "mirrored", correct_key: "80", rotation: "0"},
            {stimulus:"img/mental_rotation/RotacijaA/B-120.gif", data: {item: "B", type: "identical", correct_key: "81", rotation: "120"},
            {stimulus:"img/mental_rotation/RotacijaA/B-120m.gif", data: {item: "B", type: "mirrored", correct_key: "80", rotation: "120"},
            {stimulus:"img/mental_rotation/RotacijaA/B-180.gif", data: {item: "B", type: "identical", correct_key: "81", rotation: "180"},
            {stimulus:"img/mental_rotation/RotacijaA/B-180m.gif", data: {item: "B", type: "mirrored", correct_key: "80", rotation: "180"},
            {stimulus:"img/mental_rotation/RotacijaA/B-240.gif", data: {item: "B", type: "identical", correct_key: "81", rotation: "240"},
            {stimulus:"img/mental_rotation/RotacijaA/B-240m.gif", data: {item: "B", type: "mirrored", correct_key: "80", rotation: "240"},
            {stimulus:"img/mental_rotation/RotacijaA/B-300.gif", data: {item: "B", type: "identical", correct_key: "81", rotation: "300"},
            {stimulus:"img/mental_rotation/RotacijaA/B-300m.gif", data: {item: "B", type: "mirrored", correct_key: "80", rotation: "300"},
            {stimulus:"img/mental_rotation/RotacijaA/B-60.gif", data: {item: "B", type: "identical", correct_key: "81", rotation: "60"},
            {stimulus:"img/mental_rotation/RotacijaA/B-60m.gif", data: {item: "B", type: "mirrored", correct_key: "80", rotation: "60"},
            {stimulus:"img/mental_rotation/RotacijaA/C-0.gif", data: {item: "C", type: "identical", correct_key: "81", rotation: "0"},
            {stimulus:"img/mental_rotation/RotacijaA/C-0m.gif", data: {item: "C", type: "mirrored", correct_key: "80", rotation: "0"},
            {stimulus:"img/mental_rotation/RotacijaA/C-120.gif", data: {item: "C", type: "identical", correct_key: "81", rotation: "120"},
            {stimulus:"img/mental_rotation/RotacijaA/C-120m.gif", data: {item: "C", type: "mirrored", correct_key: "80", rotation: "120"},
            {stimulus:"img/mental_rotation/RotacijaA/C-180.gif", data: {item: "C", type: "identical", correct_key: "81", rotation: "180"},
            {stimulus:"img/mental_rotation/RotacijaA/C-180m.gif", data: {item: "C", type: "mirrored", correct_key: "80", rotation: "180"},
            {stimulus:"img/mental_rotation/RotacijaA/C-240.gif", data: {item: "C", type: "identical", correct_key: "81", rotation: "240"},
            {stimulus:"img/mental_rotation/RotacijaA/C-240m.gif", data: {item: "C", type: "mirrored", correct_key: "80", rotation: "240"},
            {stimulus:"img/mental_rotation/RotacijaA/C-300.gif", data: {item: "C", type: "identical", correct_key: "81", rotation: "300"},
            {stimulus:"img/mental_rotation/RotacijaA/C-300m.gif", data: {item: "C", type: "mirrored", correct_key: "80", rotation: "300"},
            {stimulus:"img/mental_rotation/RotacijaA/C-60.gif", data: {item: "C", type: "identical", correct_key: "81", rotation: "60"},
            {stimulus:"img/mental_rotation/RotacijaA/C-60m.gif", data: {item: "C", type: "mirrored", correct_key: "80", rotation: "60"},
            {stimulus:"img/mental_rotation/RotacijaA/D-0.gif", data: {item: "D", type: "identical", correct_key: "81", rotation: "0"},
            {stimulus:"img/mental_rotation/RotacijaA/D-0m.gif", data: {item: "D", type: "mirrored", correct_key: "80", rotation: "0"},
            {stimulus:"img/mental_rotation/RotacijaA/D-120.gif", data: {item: "D", type: "identical", correct_key: "81", rotation: "120"},
            {stimulus:"img/mental_rotation/RotacijaA/D-120m.gif", data: {item: "D", type: "mirrored", correct_key: "80", rotation: "120"},
            {stimulus:"img/mental_rotation/RotacijaA/D-180.gif", data: {item: "D", type: "identical", correct_key: "81", rotation: "180"},
            {stimulus:"img/mental_rotation/RotacijaA/D-180m.gif", data: {item: "D", type: "mirrored", correct_key: "80", rotation: "180"},
            {stimulus:"img/mental_rotation/RotacijaA/D-240.gif", data: {item: "D", type: "identical", correct_key: "81", rotation: "240"},
            {stimulus:"img/mental_rotation/RotacijaA/D-240m.gif", data: {item: "D", type: "mirrored", correct_key: "80", rotation: "240"},
            {stimulus:"img/mental_rotation/RotacijaA/D-300.gif", data: {item: "D", type: "identical", correct_key: "81", rotation: "300"},
            {stimulus:"img/mental_rotation/RotacijaA/D-300m.gif", data: {item: "D", type: "mirrored", correct_key: "80", rotation: "300"},
            {stimulus:"img/mental_rotation/RotacijaA/D-60.gif", data: {item: "D", type: "identical", correct_key: "81", rotation: "60"},
            {stimulus:"img/mental_rotation/RotacijaA/D-60m.gif", data: {item: "D", type: "mirrored", correct_key: "80", rotation: "60"},*/
            ];

        //creates a separate array for preloading the images -> the images array doesn't work because of object structure
        var preload = [];
        for (var i = 0; i < images.length; i++) {
            preload.push(images[i].stimulus);
        }

        var targets = [
            {stimulus:"img/mental_rotation/RotacijaA/A-0.gif", data: {item: "A", type: "target"}},
            {stimulus:"img/mental_rotation/RotacijaA/B-0.gif", data: {item: "B", type: "target"}},
            {stimulus:"img/mental_rotation/RotacijaA/C-0.gif", data: {item: "C", type: "target"}},
            {stimulus:"img/mental_rotation/RotacijaA/D-0.gif", data: {item: "D", type: "target"}},
        ];

        //by console.logging, pairs works fine now, but nothing gets displayed on the screen
        var pairs = [];

        for (var i = 0; i < images.length; i++) {
            // goes through the image array, sets that item as first stimulus, and then goes to targets array,
            // finds the corresponding target and sets that as second stimulus, storing both the stimuli and their data
            var second_stim = images[i];
            for (var j = 0; j < targets.length; j++ ) {
                if (targets[j].data.item === images[i].data.item) {
                    var first_stim = targets[j];
                }
            }
            // add the pair
            pairs.push([first_stim, second_stim]);
        }   

        //Fisher-Yates/Knuth shuffle algorithm to randomly mix up the pairs array,
        //from Stackoverflow: http://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array

        function shuffle(array) {
          var currentIndex = array.length, temporaryValue, randomIndex ;
          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }
          return array;
        }

        var shuffled_pairs = shuffle(pairs);   
        var shuffled_images = [];
        var shuffled_foil_data = [];

        for (i = 0; i < shuffled_pairs.length; i++) {
            shuffled_images.push([shuffled_pairs[i][0].stimulus, shuffled_pairs[i][1].stimulus]);
            //stores data from the foil item into a foil data array that will be appended to the generic data object
            shuffled_foil_data.push(shuffled_pairs[i][1].data);
        }

        console.log("shuffled images are " + shuffled_images);

        // create free-sort block for jspsych
        var rotation_block = {
            type: 'two-stim',
            stimuli: shuffled_images,
            prompt: "<p>Press Q if the images are identical, and P if mirror images of each other. Note that the images may be rotated!</p>",
            data: shuffled_foil_data
        };

        // preload images
        // call start() when loading is complete
        jsPsych.preloadImages(preload, start);
 
        // launch jspsych experiment
        function start() {
            jsPsych.init({
                display_element: $('#jspsych_target'),
                experiment_structure: [rotation_block],
                on_finish: function(data) {
                $("#jspsych_target").append($('<pre>', {
                    html: jsPsych.dataAsCSV()
                }));

                //jsPsych.saveCSVdata("data.csv");
            }
            });
        }
    </script>

</html>